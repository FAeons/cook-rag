<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½çƒ¹é¥ªåŠ©æ‰‹</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container { 
            max-width: 800px;
            width: 100%;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 700px;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 24px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 { 
            font-size: 20px; 
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .status:hover { background: rgba(255,255,255,0.25); }
        
        .status-dot {
            width: 8px; 
            height: 8px;
            border-radius: 50%;
            background: #ffc107;
            animation: pulse 2s infinite;
        }
        .status-dot.ready { 
            background: #4caf50; 
            animation: none; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        /* å¯¹è¯åŒºåŸŸ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fafbfc;
        }
        
        .chat-area::-webkit-scrollbar {
            width: 6px;
        }
        .chat-area::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }
        
        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
        }
        
        .message.user { 
            flex-direction: row-reverse; 
        }
        
        .avatar {
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .message.user .avatar { 
            background: linear-gradient(135deg, #fc5c7d 0%, #6a82fb 100%);
        }
        
        .bubble {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .message.user .bubble { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant .bubble { 
            background: #fff; 
            color: #2c3e50;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        /* å…ƒä¿¡æ¯æ ‡ç­¾ */
        .meta {
            font-size: 12px;
            color: #999;
            margin-top: 6px;
            display: flex;
            gap: 8px;
        }
        .meta-tag {
            padding: 3px 10px;
            background: #e8f5e9;
            color: #4caf50;
            border-radius: 10px;
        }
        
        /* è¾“å…¥å…‰æ ‡ */
        .cursor {
            display: inline-block;
            width: 2px;
            height: 16px;
            background: #667eea;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        @keyframes blink { 
            0%, 50% { opacity: 1; } 
            51%, 100% { opacity: 0; } 
        }
        
        /* è¾“å…¥ä¸­åŠ¨ç”» */
        .typing {
            display: flex;
            gap: 4px;
            padding: 12px;
        }
        .typing-dot {
            width: 8px; 
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 
            0%, 60%, 100% { transform: translateY(0); } 
            30% { transform: translateY(-8px); } 
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 20px 24px;
            background: #fff;
            border-top: 1px solid #e8e8e8;
            flex-shrink: 0;
        }
        
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        textarea {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            resize: none;
            font-size: 15px;
            line-height: 1.5;
            min-height: 52px;
            max-height: 120px;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        textarea:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        textarea::placeholder { 
            color: #aaa; 
        }
        
        .send-btn {
            width: 52px; 
            height: 52px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .send-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 16px rgba(102,126,234,0.4); 
        }
        .send-btn:disabled { 
            background: #e0e0e0;
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty {
            text-align: center;
            padding: 80px 40px;
            color: #999;
        }
        .empty-icon { 
            font-size: 64px; 
            margin-bottom: 20px; 
            opacity: 0.8;
        }
        .empty-text { 
            font-size: 16px; 
            margin-bottom: 12px;
        }
        .empty-hint { 
            font-size: 14px; 
            color: #bbb; 
        }
        
        /* å¿«æ·é—®é¢˜ */
        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .quick-q {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-q:hover { 
            background: #667eea; 
            color: #fff; 
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>
                <span>ğŸ‘¨â€ğŸ³</span>
                <span>æ™ºèƒ½çƒ¹é¥ªåŠ©æ‰‹</span>
            </h1>
            <div class="status" id="statusBtn">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ç‚¹å‡»åˆå§‹åŒ–</span>
            </div>
        </div>
        
        <!-- å¯¹è¯åŒºåŸŸ -->
        <div class="chat-area" id="chatArea">
            <div class="empty" id="emptyState">
                <div class="empty-icon">ğŸ³</div>
                <div class="empty-text">æˆ‘æ˜¯ä½ çš„æ™ºèƒ½çƒ¹é¥ªåŠ©æ‰‹</div>
                <div class="empty-hint">å¯ä»¥é—®æˆ‘èœè°±ã€é£Ÿææ­é…ã€çƒ¹é¥ªæŠ€å·§ç­‰é—®é¢˜</div>
                <div class="quick-questions">
                    <span class="quick-q" onclick="askQuick('çº¢çƒ§è‚‰æ€ä¹ˆåš')">ğŸ¥˜ çº¢çƒ§è‚‰æ€ä¹ˆåš</span>
                    <span class="quick-q" onclick="askQuick('è¥¿çº¢æŸ¿ç‚’é¸¡è›‹çš„åšæ³•')">ğŸ… è¥¿çº¢æŸ¿ç‚’é¸¡è›‹</span>
                    <span class="quick-q" onclick="askQuick('ä»Šå¤©åƒä»€ä¹ˆå¥½')">ğŸ¤” ä»Šå¤©åƒä»€ä¹ˆ</span>
                </div>
            </div>
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-area">
            <div class="input-wrapper">
                <textarea 
                    id="input" 
                    placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." 
                    rows="1" 
                    onkeydown="handleKey(event)" 
                    oninput="autoResize(this)"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="send()" disabled>
                    â¤
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== çŠ¶æ€å˜é‡ =====
        let ready = false;
        let processing = false;
        let sessionId = null;
        
        // ===== åˆå§‹åŒ– =====
        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                updateStatus(data.initialized);
                if (data.initialized) {
                    createSession();
                }
            } catch (e) {
                updateStatus(false);
            }
        }
        
        function updateStatus(isReady) {
            ready = isReady;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('sendBtn');
            
            if (isReady) {
                dot.className = 'status-dot ready';
                text.textContent = 'å·²å°±ç»ª';
                btn.disabled = false;
            } else {
                dot.className = 'status-dot';
                text.textContent = 'ç‚¹å‡»åˆå§‹åŒ–';
                btn.disabled = true;
            }
        }
        
        async function initSystem() {
            if (ready || processing) return;
            
            processing = true;
            const text = document.getElementById('statusText');
            text.textContent = 'åˆå§‹åŒ–ä¸­...';
            
            try {
                const res = await fetch('/api/init', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    updateStatus(true);
                    createSession();
                } else {
                    text.textContent = 'åˆå§‹åŒ–å¤±è´¥';
                }
            } catch (e) {
                text.textContent = 'åˆå§‹åŒ–å¤±è´¥';
            }
            processing = false;
        }
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        document.getElementById('statusBtn').addEventListener('click', initSystem);
        
        async function createSession() {
            try {
                const res = await fetch('/api/session/create', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    sessionId = data.session_id;
                }
            } catch (e) {
                sessionId = 'local-' + Date.now();
            }
        }
        
        // ===== æ¶ˆæ¯å¤„ç† =====
        function askQuick(q) {
            if (!ready) {
                alert("è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ");
                return;
            }
            document.getElementById('input').value = q;
            send();
        }
        
        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        }
        
        function autoResize(el) {
            el.style.height = 'auto';
            const newHeight = Math.min(el.scrollHeight, 120);  // æœ€å¤§120px
            el.style.height = newHeight + 'px';
            // ç¡®ä¿è¾“å…¥æ¡†ä¸è¶…å‡ºå¯è§†åŒºåŸŸ
            el.scrollTop = el.scrollHeight;
        }
        
        async function send() {
            const input = document.getElementById('input');
            const q = input.value.trim();
            
            if (!q || !ready || processing) return;
            
            processing = true;
            document.getElementById('sendBtn').disabled = true;
            input.value = '';
            input.style.height = 'auto';
            
            // éšè—ç©ºçŠ¶æ€
            document.getElementById('emptyState').style.display = 'none';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMsg('user', q);
            
            // æ˜¾ç¤ºåŠ è½½
            const loadingId = addLoading();
            
            try {
                await sendStream(q, loadingId);
            } catch (e) {
                removeEl(loadingId);
                addMsg('assistant', 'âŒ è¯·æ±‚å¤±è´¥: ' + e.message);
            }
            
            processing = false;
            document.getElementById('sendBtn').disabled = false;
        }
        
        // ===== æµå¼è¯·æ±‚ =====
        async function sendStream(q, loadingId) {
            const params = new URLSearchParams({
                question: q,
                session_id: sessionId || '',
                use_cache: true
            });
            
            const eventSource = new EventSource(`/api/ask/stream?${params}`);
            
            let content = '';
            let msgEl = null;
            let cached = false;
            
            eventSource.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                if (data.type === 'token') {
                    if (!msgEl) {
                        removeEl(loadingId);
                        msgEl = addMsg('assistant', '', true);
                    }
                    content += data.content;
                    updateMsg(msgEl, content);
                } else if (data.type === 'done') {
                    cached = data.cache_hit;
                    finishMsg(msgEl, content, cached);
                    eventSource.close();
                } else if (data.type === 'error') {
                    removeEl(loadingId);
                    addMsg('assistant', 'âŒ ' + data.message);
                    eventSource.close();
                }
            };
            
            eventSource.onerror = function() {
                removeEl(loadingId);
                if (!msgEl && !content) {
                    addMsg('assistant', 'âŒ è¿æ¥ä¸­æ–­');
                } else if (msgEl) {
                    finishMsg(msgEl, content, false);
                }
                eventSource.close();
            };
        }
        
        // ===== UI å·¥å…·å‡½æ•° =====
        function addMsg(role, text, streaming = false) {
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            const icon = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            const bubbleText = streaming ? text + '<span class="cursor"></span>' : text;
            
            div.innerHTML = `
                <div class="avatar">${icon}</div>
                <div>
                    <div class="bubble">${bubbleText}</div>
                </div>
            `;
            
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
            return div;
        }
        
        function updateMsg(el, text) {
            const bubble = el.querySelector('.bubble');
            bubble.innerHTML = text + '<span class="cursor"></span>';
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;  // å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
        }
        
        function finishMsg(el, text, cached) {
            const bubble = el.querySelector('.bubble');
            bubble.textContent = text;
            
            if (cached) {
                const wrapper = bubble.parentElement;
                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.innerHTML = '<span class="meta-tag">âš¡ ç¼“å­˜</span>';
                wrapper.appendChild(meta);
            }
        }
        
        function addLoading() {
            const area = document.getElementById('chatArea');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = id;
            div.innerHTML = `
                <div class="avatar">ğŸ¤–</div>
                <div class="typing">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
            return id;
        }
        
        function removeEl(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        
        // ===== å¯åŠ¨ =====
        checkStatus();
        // setInterval(checkStatus, 3000);  // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ç³»ç»ŸçŠ¶æ€,å¢åŠ å®šæ—¶è½®è¯¢ç¡®ä¿çŠ¶æ€å®æ—¶æ›´æ–°
    </script>
</body>
</html>